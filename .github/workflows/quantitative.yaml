name: Quantitative tests

on:
  pull_request_target:
    branches:
      - main
  merge_group:

# Pin tool versions to prevent problems
permissions: {}
jobs:
  regression:
    runs-on: ubuntu-latest
    outputs:
      test_status: ${{ steps.tests.outcome }}
    permissions:
      pull-requests: write
    steps:
      - name: "Checkout repo"
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          ref: ${{ github.event.pull_request.head.sha }}

      - name: "Checkout main repo"
        uses: actions/checkout@1af3b93b6815bc44a9784bd300feb67ff0d1eeb3 # v6.0.0
        with:
          repository: coreruleset/coreruleset
          ref: 'main'
          path: 'mainBranchFolder'

      - name: "Run tests"
        id: quantitative
        continue-on-error: true
        run: |

          OLD_FALSE_POSITIVES=$(jq -r '.falsePositives' old.json)
          NEW_FALSE_POSITIVES=$(jq -r '.falsePositives' new.json)
          
          echo $OLD_FALSE_POSITIVES
          echo $NEW_FALSE_POSITIVES

          if [ "$NEW_FALSE_POSITIVES" -eq "$OLD_FALSE_POSITIVES" ]; then
            echo -e " âš ï¸ Quantitative testing detected new false positives"
            echo -e "ðŸ“ Total false positives: \`$OLD_FALSE_POSITIVES\` -> \`$NEW_FALSE_POSITIVES\`\n<details>\n"
            exit 1
          else
            echo -e " ðŸš€ Quantitative testing did not detect new false positives"
          fi

  manual_approval:
    needs: regression
    if: needs.regression.outputs.test_status != 'success'
    runs-on: ubuntu-latest
    environment: review   # triggers manual approval
    steps:
      - run: |
          echo "Quantitative tests failed (even if they are green) â€” reviewer approval required for the new FP added!"
          echo "needs.regression.outputs.test_status:"
          echo ${{ needs.regression.outputs.test_status }}

